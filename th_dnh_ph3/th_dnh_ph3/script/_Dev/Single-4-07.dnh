#TouhouDanmakufu[Single]
#ScriptVersion[3]
#Title["Test Sign \"I Can't Believe There Was a Bullet in that Gap!\""]
#Text["..."] 
#BGM["./bgm/bgm - Bhava-Agra As Seen Through a Child's Mind.mp3"]
#System["./system/Default_System.txt"]
#Background["./system/Background_Sky.txt"]

#include "./Index.txt"




let fog;

let timer = -30; //30

@Event
{
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)
	{
		SetScriptResult(2000);
	}
	case(EV_REQUEST_SPELL_SCORE){
        SetScriptResult(5000000);
    }
	 //case(EV_REQUEST_IS_DURABLE_SPELL) {
		// SetScriptResult(true);
	 //}
	case(EV_REQUEST_TIMER) { SetScriptResult(timer*60); } //4500
}
@Initialize
{
	SetCommonData("CurrentSC","\"I Can't Believe There Was a Bullet in that Gap!\"");
	SetCommonData("Difficulty","Normal");
	
	boss = spawnBoss();
	
	ObjEnemy_SetDamageRate(boss,0,0);
	SetShotAutoDeleteClip(32,32,32,32);
	
	EnemyName(boss, "Andi", 255, 180, 255);
	
	MainTask;
	

}
@MainLoop
{

	if(ObjEnemy_GetInfo(boss, INFO_LIFE) <= 0 && !finishing)
	{
		finishing = true;
		TBreakSpell([]);
	}
	else {
		SetBossHitbox(boss,ex,ey);
	}
	frame++;
	yield;
}


task MainTask {
	
	ObjEnemy_SetDamageRate(boss,0,0);
	//ObjMove_SetDestAtFrame(boss, rand(cx+60, cx-60), rand(cy-120, cy-90), 60);
	ObjMove_SetDestAtFrame(boss, cx, cy-120, 60);
	
	
	SetSpellCard;
	MCircNextAlpha = 80;
	Obj_SetValue(objSpellCircle,"MaxAlpha",64);
	
	ObjEnemyBossScene_StartSpell(objScene);
	ObjEnemyBossScene_SetSpellTimer(objScene,timer*60); //5760
	//TAfterImageBoss(boss,[255,255,255],1,1,15,3,BLEND_ADD_ARGB,0);
	//SE_Play(nyaa,60);
	//SetCaution;
	
	//SetBossBlur(true);

	wait(90);
	
	ObjEnemy_SetDamageRate(boss,24,8);


	
	frame = 0;
	
//	TShoot;
//	TBigShots;
	//Tmovement(cx-60,cx+60, cy,cy-60, 60,240, []); //[MOVE_PLAYERBIAS,2,0]
//	Tmovement(30,sx-30, 30,cy+90, 60,240, [MOVE_NEAR,150,MOVE_FAR,50,MOVE_PNLSPACE,50,MOVE_MAXSPEED,1.5,MOVE_SMOOTH,10]); //[MOVE_PLAYERBIAS,2,0]

	//CallFan("Bright",1);
	//Aura (boss,255,0,200);
//	Aura (boss,180,180,255);
//	TFog;
	
	TGaps;
	
//	TFeathers;
	
	wait(180); 
	//TShoot;
	
}










task TGaps {
	let outgap;
	let ingap;
	let x; let y;
	let seobj=ObjSound_Create;
	
//	ObjMove_SetDestAtWarp(boss, 60,90, 0);
	
	// outgap = CreateGapA1(cx,cy+100,300,40, 45, 180, GAP_OUT,0);
	// wait(30);
	// ingap = CreateGapA1(cx, cy,300,40, 90, 150, GAP_IN,outgap);
	// wait(30);
	
	// ObjMove_SetDestAtFrame(boss,sx-60,90,120);
	// loop(120){
		// CreateShotA1(ex,ey,2,angleBetween(ex,ey,px,py),DOT_YELLOW,10);
		// SE_PlayA2(se_shot,60,seobj,30);
		// yield;
	// }
	ObjMove_SetDestAtWarp(boss,cx,cy,0);
	wait(30);
	
	
	
	let N = 4;
	let dA2 = 360/N;
	let i = 0;
	while(i < N) {
		outgap = CreateGapA1(cx+100*cos(dA2*i+180),cy+100*sin(dA2*i+180),100,45, dA2*i+0  , 9990, GAP_OUT,TARGET_ALL,0);
		i++;
		ingap  = CreateGapA1(cx+100*cos(dA2*i+0  ),cy+100*sin(dA2*i+0  ),300,45, dA2*i+180, 9990, GAP_IN,TARGET_ALL,outgap);
		i++;
	}
	
	let dA = 5;
	
	let a = 0;
	loop{
		//FireWedgeA1(ex,ey,dA*i+0,2,620,5,	10,6,7, 20,10);
		//Ooooh
		loop(10){ CreateShotA1(swdx,swdy,rand(1,3), a+0, 620, 5); a+=10; }
		a+=50; wait(10); SetAttackPose(10); wait(10);
	}
	
	
	// let dA = 10;
	
	// let i = 0;
	loop{
		
		outgap = CreateGapA1(cx+100*cos(dA*i+180),  cy+100*sin(dA*i+180),  300,45, dA*i+0  , 90, GAP_OUT,0);
		ingap  = CreateGapA1(cx+100*cos(dA*i+0  ),cy+100*sin(dA*i+0  ),300,45, dA*i+180,   90, GAP_IN,outgap);
		FireWedgeA1(ex,ey,dA*i+0,2,SUPP_MAGENTA,5,	10,6,7, 20,10);
		
		i++; wait(100); SetAttackPose(45); wait(20);
	}
	
	ObjMove_AddPatternB1(boss,0,1,0);
	let dir=1;
	
	loop{
		if(ex>sx-30 || ex<30){
			dir*=-1;
			ObjMove_AddPatternB1(boss,0,dir,0);
		}
		CreateShotA1(ex,ey,2,angleBetween(ex,ey,px,py),DOT_YELLOW,10);
		SE_PlayA2(se_shot,60,seobj,30);
		yield;
	}
	
	
	while(!Obj_IsDeleted(boss)){
		outgap = CreateGapA1(rand(0,sx),rand(0,cy),300,40, rand(0,180), 240, GAP_OUT,0);
		
		wait(60); if(Obj_IsDeleted(boss)){break;}
		x=ex; y=ey;
		ObjMove_SetDestAtWarp(boss, rand(0,sx), rand(0,cy-120), 0);
		wait(20); if(Obj_IsDeleted(boss)){break;}
		ingap = CreateGapA1(x,y,300,100, angleBetween(x,y,ex,ey), 240, GAP_IN,outgap);	
		wait(30); if(Obj_IsDeleted(boss)){break;}
		FireWedgeA1(ex,ey,angleBetween(ex,ey,x,y),2,SUPP_MAGENTA,5,	10,6,5, 20,10);
		wait(150);
	}
	
	
}







	
	
