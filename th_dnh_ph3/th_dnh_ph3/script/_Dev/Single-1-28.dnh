#TouhouDanmakufu[Single]
#ScriptVersion[3]
#Title["Blade Dance \"Reverse Dominance\""]
#Text["..."] 
#BGM["./bgm - Last Word.ogg"]
#System["./system/Default_System.txt"]
#Background["./system/Background_Stars.txt"]

#include "./Index.txt"



let move = 1;
let finishing = false;




@Event
{
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)
	{
		SetScriptResult(2000);
	}
	case(EV_REQUEST_SPELL_SCORE){
        SetScriptResult(5000000);
    }
	case(EV_REQUEST_IS_DURABLE_SPELL) {
		SetScriptResult(true);
	}
	case(EV_REQUEST_TIMER) { SetScriptResult(4500); }
}
@Initialize
{
	SetCommonData("CurrentSC","Blade Dance \"Reverse Dominance\"");
	SetCommonData("Difficulty","\"Hard\"");
	
	boss = spawnBoss();
	
	ObjEnemy_SetDamageRate(boss,0,0);
	SetShotAutoDeleteClip(64,32,64,32);
	
	EnemyName(boss, "Andi", 255, 180, 255);
	
	MainTask;
	
	
}
@MainLoop
{

	if(ObjEnemy_GetInfo(boss, INFO_LIFE) <= 0 && !finishing)
	{
		finishing = true;
		TBreakSpell([]);
	}
	else {
		ObjEnemy_SetIntersectionCircleToShot(boss, ex, ey, 32); //hitbox against player bullets. 32 is the radius.
		ObjEnemy_SetIntersectionCircleToPlayer(boss, ex, ey, 24); //hitbox against the player. 24 is the radius.

	}
	frame++;
	yield;
}


task MainTask {
	
	ObjEnemy_SetDamageRate(boss,0,0);
	ObjMove_SetDestAtFrame(boss, rand(cx+60, cx-60), rand(120, cy-60), 60);
	
	MCircAlpha=0;
	SetSurvivalCard;
	ObjEnemyBossScene_StartSpell(objScene);
	ObjEnemyBossScene_SetSpellTimer(objScene,2000); //5760
	
	wait(60);
	
	ObjEnemy_SetDamageRate(boss,24,8);

	
	//movement;
	
	frame = 0;
	
	TLasers;
	
	
}



task movement {
	while(!Obj_IsDeleted(boss)) {
		alternative(move)
		case(1) {
			ObjMove_SetDestAtFrame(boss, cx+rand(-90,90), rand(60, cy-60), 120);
			wait(240);
		}
		//hang around center and move very slowly
		case(2) {
			ObjMove_SetDestAtSpeed(boss, (ex+cx)/2+rand(-30,30), (ey+cy)/2+rand(-30,30), 0.1); //0.1
			wait(240);
		}
		//hang around top and don't move too fast
		case(3) {
			ObjMove_SetDestAtSpeed(boss, (ex+cx)/2+rand(-40,40), (ey+cy)/2+rand(-60,-120), 0.3);
			wait(240);
		}
	}
}




task TLasers {
	let seobj = ObjSound_Create;
	let seobj2 = ObjSound_Create;
	
	let del0 = 60; //130
	let delscale = -0.01; //-1.35; 0.5, -1.25;  1.2, -10, -2.5
	let del;
	
	let las; let shot; let shots;
	let length = 100;
	let frq = 5; //5
	let amp;
	let poff = 0; //periodic offset
	let type = 1030; //1009 //1030
	let tilt = 0;
	
	let dur = 30; //20
	
	let ang; let dx; let dy; let accx; let accy;
	
	let isFlip = 0;
	let ramp = 0;
	
	let N = 75; //100
	let gapN = 2*cy/N;
	let scaleN = 100/N;
	
	let arcDir;
	
	let x0; let y0; let x; let y;
	y0 = cy*2; let yF = 0; let ydir = -1;
	while(!Obj_IsDeleted(boss)) {
	
		MCircNextPeriod = ( 30/scaleN + delscale*N/scaleN + (1+N/scaleN)*scaleN ) / (0.5*scaleN);
		
		ConcentrationA2(boss,"HEART",20/scaleN,3,100,[255,200-0.5*ramp*scaleN*100,255-0.25*ramp*scaleN*100]); //255,100,255
		//SE_Play(charge3,70);
		wait(30/scaleN);
		
		x0 = px; 
		y0 = cy*2-y0; 
		yF = cy*2-yF;
		ydir*=-1;
		amp = rand(0.8,1.2)*randSign(); //1
		poff = rand(0,90);
		
		x=px+100*amp*sin((poff+0)*frq); 
		y=y0+15*ydir;
		arcDir = -1;
		if(ex>x){arcDir*=-1;}
		
		MCircAlpha = 127;
		
		shots = bulletArc(ex, ey, x, y, Distance(ex,ey,x,y)/5, arcDir, 0, 735, 255, [255,150,200], 0,0,10); //533
		let len = Distance(ex,ey,x,y)/5; //length(shots);
		//arc corona
		// ascent(i in 0..len) {
			// //ObjRender_SetAlpha(shots[i],0);
			// shot = CreateShotA1(ObjMove_GetX(shots[i]), ObjMove_GetY(shots[i]), 2,ObjMove_GetAngle(shots[i])+90+15*rand(-1,1), 533,0);
			// ObjRender_SetAlpha(shot,200);
			// ObjRender_SetColor(shot,255-i/3,0,i*3);
			// ObjRender_SetScaleXYZ(shot,2,2,1);
			// ObjShot_SetIntersectionEnable(shot,false);
			// DelayFadeDelete(shot,30);
		// }
		SE_Play(se_shot,70);
		ObjMove_SetPosition(boss,x,y0);
		
		ScreenShake(30,5,5);
		
		ObjEnemy_SetDamageRate(boss,0,0);
		ascent(i in 0..N) {
			//type = 1018+(i%7);
			
			del = del0+delscale*i*scaleN;
			length = 100+120*sin(i);
			isFlip = i%2;
			ramp = frame/N; //120
			tilt = ramp*i*scaleN; //sin(frq*i) * 0.1*ramp * i; //15*sin(frq*i); 5*; i*
			x = x0-length/2+(100*amp*sin((poff+i)*frq)+length*isFlip); //*tilt;
			y = y0+gapN*i*ydir;
			
			las = CreateStraightLaserA1(x,y,0+tilt+180*isFlip,length+2.5*ramp,20,dur,type,del);
			ObjStLaser_SetSource(las,false);
			ObjRender_SetColor(las,255,255-0.5*ramp*scaleN*i,255-0.25*ramp*scaleN*i);
			
			ang = 90 + rand(20,40)*sin(frq*i*scaleN)*randSign();
			dx = 3*cos(ang); accx = -0.005* sign(dx);
			dy = -4 * sin(ang); accy = 0.05;
			
			//trailing sparks/hearts
			shot = CreateShotA1(x,y, 0,0+tilt+180*isFlip, 741, 0); //533//735 //15
			// //ObjMove_AddPatternB2(shot, del, dx,dy, accx,accy, 0.05*sign(dx), 10);
			// ObjMove_AddPatternA2(shot,del,dx,tilt+180*isFlip,0.05,0,3);
			ObjRender_SetAlpha(shot,155);
			ObjRender_SetColor(shot,255,255-0.5*ramp*scaleN*i,255-0.25*ramp*scaleN*i);
			ObjShot_SetIntersectionEnable(shot,false);
			DelayFadeDelete(shot,del+dur/2);
			//ObjShot_FadeDelete(shot);
			Phase2(shot,45,0, 155);
			
			//trailing corona
			// shot = CreateShotA1(x, y, 2,ObjMove_GetAngle(boss)+90+15*rand(-1,1), 533,0);
			// ObjMove_SetDestAtWeight(shot, x+rand(-15,15), y, 1,10);
			// ObjRender_SetAlpha(shot,200);
			// ObjRender_SetColor(shot,255-i/3*scaleN,0,i*3*scaleN);
			// ObjRender_SetScaleXYZ(shot,2,2,1);
			// ObjShot_FadeDelete(shot);
			corona(x,y,angleBetween(x,y,x+rand(-10,10),y+10*ydir),2, [255-i/3*scaleN,0,i*3*scaleN]);
			AfterImageB1(boss,GetCurrentScriptDirectory()~"boss.png",[255,127,255],1,0,10, 1,1,64,64, 0);
			
		//	line(y,x,2*(isFlip-0.5),30,0.1,del*2,15,5);
			
			ObjMove_SetDestAtFrame(boss, x0+100*amp*sin((poff+i)*frq), y, 5);
			
			//boss corona
			corona(ex,ey,angleBetween(ex,ey,x0+100*amp*sin((poff+i)*frq+rand(-15,15)), y),3, [255-i/3*scaleN,0,i*3*scaleN]);
			
			
			//yield;
			loop(floor(1*i*scaleN)/i) {
				SE_PlayA2(laser2,70,seobj,30);
			//	SE_PlayA2(charge3,i*scaleN,seobj2,120);
				yield;
			}
		}
		MCircAlpha = 0;
		
	//	bulletArc(ex, ey, ex, -30, Distance(ex,ey,ex,-90)/5,sign(cx-ex), 0, 735, 255, [255,150,200], 0, 0, 10);
	//	ObjMove_SetY(boss,-90);
	//	ObjMove_SetDestAtFrame(boss, x0, y0-90*ydir, 60);
		//wait(del0+delscale*100);
		ObjEnemy_SetDamageRate(boss,24,8);
		wait(delscale*N/scaleN);
		//ScreenShake(60,12,12);
		SE_Play(charge3,100);
	}

	// function sweep() {
		// let xmspd = -2*amp;
		// let yspd = 2.5;
		// let turndel = 10*frq;
		// let xmacc = 0.0725 * xmspd * (2/yspd);
		
		// ascent(i in 0..20) {
			// shot = CreateShotB2(x0+sign(i-10)*(length/2 + i * 20),-60, 0,yspd, 0,-0.05, 0,yspd, 533, 0);
			// ObjRender_SetColor(shot,255-i*3,0,i*3);
			// Phase2(shot,45,0, 155);
			// ascent(j in 0..10) {
				// ObjMove_AddPatternB2(shot,turndel/2+j*turndel,NO_CHANGE,NO_CHANGE,xmacc*2*(j%2-0.5),NO_CHANGE,xmspd*2*(j%2-0.5),yspd+0.15*(i%2));
			// }
		// }
	// }
	
	N *= 0.8; //100
	gapN = sy/N;
	scaleN = 100/N;


}

task line(y,x0,dir,gap,gapscale,del,warn,dur) {
	let shot; let shots = [];
	let x = x0;
	wait(del);
	ascent(i in 0..10) {
		x += gap*dir + gap*dir*(gapscale*i);
		shot = CreateShotA1(x,y,0,90, 533, 0);
		ObjRender_SetColor(shot,200,0,128);
		Phase2(shot,warn,0,250);
		ObjShot_SetSpellResist(shot,true);
		shots = shots ~ [shot];
	}
	wait(dur+warn);
	ascent(i in 0..10) {
		ObjShot_FadeDelete(shots[i]);
	}
	
}


function corona(x,y,ang,scale, c) {
	let shot = CreateShotA1(x, y, 2, ang, 533, 0);
	//ObjMove_SetDestAtWeight(shot, x+rand(-15,15), y, 1,10);
	ObjRender_SetAlpha(shot,200);
	ObjRender_SetColor(shot,c[0],c[1],c[2]);
	ObjRender_SetScaleXYZ(shot,scale,scale,1);
	ObjShot_SetIntersectionEnable(shot,false);
	ObjShot_FadeDelete(shot);
	return shot;
}









task TFinalize() {
	
	
	SE_Play(spellbreak,100);
	DeleteShotAll(TYPE_ALL, TYPE_ITEM);
	PPCExplode(boss,[255,255,255]); PPCExplodeRainbow(boss);
	wait(15);
		
	
	Obj_Delete(boss);
	CloseScript(GetOwnScriptID());
	return;
	
	//ExplosionB2(boss,"HEART",[255,100,255],[255,100,255]);
	/*
	//ExplodeCherry(ex,ey,0.1);
	ExplodeRGB(ex, ey, 2, 1, 255, 255, 255);
	DeleteShotAll(TYPE_ALL,TYPE_ITEM);
	SE_Play(defeated,1000);
	StopSlow(TARGET_ALL);
	ascent(i in 0..60) {
		ObjRender_SetAlpha(boss, 255-i*4.25);
		yield;
	}
	//wait(60);
	Obj_Delete(boss);
	
	*/
	//CloseScript(GetOwnScriptID());
	//return;
}


//CreateSunShotA1(x, y, speed, angle, type, initScale, sizePerFrame, endScale, texture2, texture, r, g, b)