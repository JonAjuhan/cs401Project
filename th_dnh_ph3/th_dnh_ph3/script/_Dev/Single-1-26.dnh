#TouhouDanmakufu[Single]
#ScriptVersion[3]
#Title["Identity \"Emotional Upwelling\""]
#Text["..."] 
#BGM["./bgm - Last Word.ogg"]
#System["./system/Default_System.txt"]
#Background["./system/Background_Stars.txt"]

#include "./Index.txt"



let move = 1;
let finishing = false;





@Event
{
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)
	{
		SetScriptResult(2000);
	}
	case(EV_REQUEST_SPELL_SCORE){
        SetScriptResult(5000000);
    }
//	case(EV_REQUEST_IS_DURABLE_SPELL) {
//		SetScriptResult(true);
//	}
	case(EV_REQUEST_TIMER) { SetScriptResult(4500); }
}
@Initialize
{
	SetCommonData("CurrentSC","Identity \"Emotional Upwelling\"");
	SetCommonData("Difficulty","\"Normal\"");
	
	boss = spawnBoss();
	
	ObjEnemy_SetDamageRate(boss,0,0);
	SetShotAutoDeleteClip(64,32,64,32);
	
	EnemyName(boss, "Andi", 255, 180, 255);
	
	MainTask;
	
	


}
@MainLoop
{
	if(ObjEnemy_GetInfo(boss, INFO_LIFE) <= 0 && !finishing)
	{
		finishing = true;
		TBreakSpell([]);
	}
	else {
		ObjEnemy_SetIntersectionCircleToShot(boss, ex, ey, 32); //hitbox against player bullets. 32 is the radius.
		ObjEnemy_SetIntersectionCircleToPlayer(boss, ex, ey, 24); //hitbox against the player. 24 is the radius.

	}
	frame++;
	yield;
}


task MainTask {
	
	ObjEnemy_SetDamageRate(boss,0,0);
	ObjMove_SetDestAtFrame(boss, rand(cx+60, cx-60), rand(120, cy-60), 60);
	
	SetSpellCard;
	ObjEnemyBossScene_StartSpell(objScene);
	ObjEnemyBossScene_SetSpellTimer(objScene,5760); //5760
	
	wait(60);
	
	ObjEnemy_SetDamageRate(boss,24,8);

	
	movement;
	
	frame = 0;
	
	TLasers;
	
	PlaytestInvincibility;
	
}



task movement {
	while(!Obj_IsDeleted(boss)) {
		alternative(move)
		case(1) {
			ObjMove_SetDestAtFrame(boss, cx+rand(-90,90), rand(60, cy-60), 120);
			wait(240);
		}
		//hang around center and move very slowly
		case(2) {
			ObjMove_SetDestAtSpeed(boss, (ex+cx)/2+rand(-30,30), (ey+cy)/2+rand(-30,30), 0.1); //0.1
			wait(240);
		}
		//hang around top and don't move too fast
		case(3) {
			ObjMove_SetDestAtSpeed(boss, (ex+cx)/2+rand(-40,40), (ey+cy)/2+rand(-60,-120), 0.3);
			wait(240);
		}
	}
}




task TLasers {
	let seobj = ObjSound_Create;
	let seobj2 = ObjSound_Create;
	
	let del0 = 130; //120 //130
	let delscale = -1.35; //0.5, -1.25;  1.2, -10, -2.5
	let del;
	
	let las; let shot;
	let length = 100;
	let frq = 5; //5
	let amp;
	let poff = 0; //periodic offset
	let type = 1009;
	let tilt = 0;
	
	let dur = 30; //20
	
	let ang; let dx; let dy; let accx; let accy;
	
	let isFlip = 0;
	
	let x0; let y0; let x; let y;
	while(!Obj_IsDeleted(boss)) {
		wait(60);
		ConcentrationA2(boss,"HEART",60,3,100,[255,100,255]);
		//SE_Play(charge3,70);
		wait(60);
		
		
		x0 = px; y0 = 0;
		amp = rand(0.8,1.2)*randSign(); //1
		poff = rand(0,90);
	
		
		//sweep();

		ascent(i in 0..100) {
			//type = 1018+(i%7);
			
			del = del0+delscale*i;
			length = 100+120*sin(i);
			isFlip = i%2;
			tilt = sin(frq*i) * 0.1*(frame/120); //15*sin(frq*i); 5*; i*
			x = x0-length/2+(100*amp*sin((poff+i)*frq)+length*isFlip)*cos(tilt); //*tilt;
			y = y0+5*i+10*sin(tilt);
			
			las = CreateStraightLaserA1(x,y,0+tilt+180*isFlip,length,20,dur,type,del);
			ObjStLaser_SetSource(las,false);
			
			ang = 90 + rand(20,40)*sin(frq*i)*randSign();
			dx = 3*cos(ang); accx = -0.005* sign(dx);
			dy = -4 * sin(ang); accy = 0.05;
			
			shot = CreateShotB2(x,y, 0,0, 0,0, 0,0, 533, 15);
			ObjMove_AddPatternB2(shot, del, dx,dy, accx,accy, 0.05*sign(dx), 10);
			ObjRender_SetAlpha(shot,155);
			ObjRender_SetColor(shot,255-i/3,0,i*3);
			Phase2(shot,45,0, 155);
			
			line(y,x,2*(isFlip-0.5),30,-0.8,del*2,15,5);
			
			SE_PlayA2(se_laser2,45,seobj,30);
			SE_PlayA2(charge3,i,seobj2,120);
			yield;
		}
	//	SE_Play(charge3,70);
		wait(del0+delscale*100);
		ScreenShake(60,12,12);
		
		wait(120);
	}

	// function sweep() {
		// let xmspd = -2*amp;
		// let yspd = 2.5;
		// let turndel = 10*frq;
		// let xmacc = 0.0725 * xmspd * (2/yspd);
		
		// ascent(i in 0..20) {
			// shot = CreateShotB2(x0+sign(i-10)*(length/2 + i * 20),-60, 0,yspd, 0,-0.05, 0,yspd, 533, 0);
			// ObjRender_SetColor(shot,255-i*3,0,i*3);
			// Phase2(shot,45,0, 155);
			// ascent(j in 0..10) {
				// ObjMove_AddPatternB2(shot,turndel/2+j*turndel,NO_CHANGE,NO_CHANGE,xmacc*2*(j%2-0.5),NO_CHANGE,xmspd*2*(j%2-0.5),yspd+0.15*(i%2));
			// }
		// }
	// }

}

task line(y,x0,dir,gap,gapscale,del,warn,dur) {
	let shot; let shots = [];
	let x = x0;
	wait(del);
	ascent(i in 0..10) {
		x += gap*dir + gap*dir*(gapscale*i);
		shot = CreateShotA1(x,y,0,90, 533, 0);
		ObjRender_SetColor(shot,200,0,128);
		Phase2(shot,warn,0,250);
		ObjShot_SetSpellResist(shot,true);
		shots = shots ~ [shot];
	}
	wait(dur+warn);
	ascent(i in 0..10) {
		ObjShot_FadeDelete(shots[i]);
	}
	
}












task TFinalize() {
	
	
	SE_Play(spellbreak,100);
	DeleteShotAll(TYPE_ALL, TYPE_ITEM);
	PPCExplode(boss,[255,255,255]); PPCExplodeRainbow(boss);
	wait(15);
		
	
	Obj_Delete(boss);
	CloseScript(GetOwnScriptID());
	return;
	
	//ExplosionB2(boss,"HEART",[255,100,255],[255,100,255]);
	/*
	//ExplodeCherry(ex,ey,0.1);
	ExplodeRGB(ex, ey, 2, 1, 255, 255, 255);
	DeleteShotAll(TYPE_ALL,TYPE_ITEM);
	SE_Play(defeated,1000);
	StopSlow(TARGET_ALL);
	ascent(i in 0..60) {
		ObjRender_SetAlpha(boss, 255-i*4.25);
		yield;
	}
	//wait(60);
	Obj_Delete(boss);
	
	*/
	//CloseScript(GetOwnScriptID());
	//return;
}


//CreateSunShotA1(x, y, speed, angle, type, initScale, sizePerFrame, endScale, texture2, texture, r, g, b)