#TouhouDanmakufu[Single]
#ScriptVersion[3]
#Title["Nullify \"It All Comes Tumbling Down\""]
#Text["..."] 
#BGM["./bgm/bgm - Hartmann's Youkai Girl.ogg"] //Bhava-Agra As Seen Through a Child's Mind.mp3"]
#System["./system/Default_System.txt"]
#Background["./system/Background_Sky.txt"]

#include "./Index.txt"

let timer = 77; //37
let shot;

@Event
{
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)
	{
		SetScriptResult(2000);
	}
	case(EV_REQUEST_SPELL_SCORE){
        SetScriptResult(5000000);
    }
	case(EV_REQUEST_IS_DURABLE_SPELL) {
		SetScriptResult(true);
	}
//	case(EV_REQUEST_IS_LAST_SPELL){
//		SetScriptResult(true);
//	}
	
	case(EV_REQUEST_TIMER) { SetScriptResult(timer*60); }
}
@Initialize
{
	SetCommonData("CurrentSC","Nullify \"It All Comes Tumbling Down\"");
	SetCommonData("Difficulty","Extra");
	
	boss = spawnBoss();
	
	ObjEnemy_SetDamageRate(boss,0,0);
	//SetShotAutoDeleteClip(64,96,64,64);
	SetShotAutoDeleteClip(16,16,16,16);
	
	MainTask;
	

}
@MainLoop
{

	if(ObjEnemy_GetInfo(boss, INFO_LIFE) <= 0 && !finishing)
	{
		finishing = true;
		TBreakSpell([]);
	}
	else {
		SetBossHitbox(boss,ex,ey);
	}
	frame++;
	yield;
}


task MainTask {
	
	ObjEnemy_SetDamageRate(boss,0,0);
	ObjMove_SetDestAtFrame(boss, cx, cy-120, 60);
	
	SetSpellCard;
	MCircNextAlpha = 80;
	Obj_SetValue(objSpellCircle,"MaxAlpha",64);
	
	ObjEnemyBossScene_StartSpell(objScene);
	ObjEnemyBossScene_SetSpellTimer(objScene,timer*60); //5760
	
//	SetCaution;
//	SetBossBlur(true);
	AuraRainbow(boss,255,255,255);
	TSpellImmune;

	//ConcentrationA2(boss,"HEXAGON",90,3,10,[255,0,255]);
		
	wait(90);
	Tmovement(cx-120,cx+120, cy-90,cy-60, 60,240, [MOVE_PLAYERBIAS,2,0,MOVE_MAXSPEED,1.5] );
	ObjEnemy_SetDamageRate(boss,24,8);
	frame = 0;

//	TShoot;

	TRotCircles;
	TWalls;
	
//	TShotWall;
	//TPlayerRotCircle;
	//TPlayerWarpCircle;
	
	//TPlayerGap(cx,cy+120,50,0.5);
	//TPlayerGap(px,py+00,50,0.5);
	
//	TCrush;
}







task TShoot {
	
	let shot;

	let types = [DOT_MAGENTA+500,DOT_BLUE+500];
	
	let count = 0; let dir = 1; let ydir;
	let sa;
	
	while(!Obj_IsDeleted(boss)) {
	
		shot = CreateShotA2(swdx,swdy,0,90+(180*sin(count/180))+count*sin(count)+120*randint(0,2), sin(count),1.5, DOT_GREEN+500, rand(5,10) );
		setvals(shot,["Acceleration","MaxSpeed"],[sin(count), 1.5]);
		Trail(shot);
		loop(10){yield; count++;}

	}
}

task Trail(shot){
	let cpy;
	wait(rand(0,10));
	while(!Obj_IsDeleted(shot)){
		cpy = CopyShot(shot);
		ObjMove_SetAngularVelocity(cpy,rand(-0.15,0.15));
	//	ObjMove_SetSpeed(cpy,0);
	//	ObjMove_SetAcceleration(cpy,getval(cpy,"Acceleration")-rand(0,0.5));
		ObjMove_SetMaxSpeed(cpy,getval(cpy,"MaxSpeed")-rand(0,0.5));
		wait(rand(20,40));
	}
}





function ActivateShots(shots){
	ascent(i in 0..length(shots)){
		shot=shots[i];
		ObjShot_SetIntersectionEnable(shot,true);
		setval(shot,"WasInfluenced",true);
		ObjRender_SetColor(shot,255,255,255);
	}
}






function ShrinkRotCircle(x,y,spd,size,dur){
	SE_Play(se_chime2,100);
	let circ = InfluenceCircleA1(x,y,size,INFL_REVOLVE,spd,1);
	task TUpdate{
		descent(i in 0..dur){
			ObjRender_SetScaleXYZ(circ,size/128*i/dur,size/128*i/dur,1);
			yield;
		}
		Obj_Delete(circ);
	}
	TUpdate;
	return circ;
}

function ShrinkWarpCircle(x,y,spd,size,dur){
//	SE_Play(se_chime2,100);
	let circ = TPlayerGap(x,y,size,spd); //InfluenceCircleA1(x,y,size,INFL_REVOLVE,spd,1);
	task TUpdate{
		ascent(i in 0..dur){
			ObjRender_SetScaleXYZ(circ,size/128*i/dur,size/128*i/dur,1);
			yield;
		}
		descent(i in 0..dur){
			ObjRender_SetScaleXYZ(circ,size/128*i/dur,size/128*i/dur,1);
			yield;
		}
		Obj_Delete(circ);
	}
	TUpdate;
	return circ;
}



task TRotCircles{
	let x; let y; let rad; let n;
	while(!Obj_IsDeleted(boss)){
		loop(5){
			x=px; y=py; rad=0; n=0;
			while(rad >= getdist(x,y,px,py) && n<100){
				x = rand(0,sx); y = rand(0,sy);
				rad = rand(50,rand(51,rand(100,300)));
				n++;
			}
			ShrinkWarpCircle(x,y,3*randSign,rad, rand(60,rand(61,300)) );
			//TPlayerWarpCircle;
			wait(8);
		}
		wait(120);
	}
}








function TPlayerGap(x,y,rad,spd){
	//let x = cx; let y = cy+120; let rad = 50; let spd = 0.5;
	let circ = InfluenceCircleA1(x,y,rad,INFL_REVOLVE,spd,0);
	//let circ = InfluenceCircleA1(x,y,rad,INFL_AIMACCEL,[0.1,3],GetPlayerObjectID);
	//let circ = InfluenceCircleA1(x,y,rad,INFL_ACCEL,[0,0],NULL);
	setval(circ,"IsProp",true);
	setcolor(circ,[64,0,255]);
	ObjRender_SetBlendType(circ,BLEND_MULTIPLY);
	let dist; let ang; //let plr = GetPlayerObjectId;
	Update;
	ObjRender_SetColor(getval(circ,"RenderObject"),128,0,64);
	//TWheel(circ,spd);
	return circ;
	
	task Update{
		while(!Obj_IsDeleted(circ)){
			rad = 116*ObjRender_GetScaleX(circ);
			x=getrx(circ); y=getry(circ);
			dist = getdist(px,py,x,y);
			spd = getvald(circ,"Mag",spd);
			if(dist < rad){
				ang = getangle(px,py,x,y)+180; //+180
				setpos(GetPlayerObjectID,x+(dist)*cos(ang+spd),y+(dist)*sin(ang+spd));
				//Set2DCameraAngleZ(Get2DCameraAngleZ+0.5);
			//	SE_Play(se_warp,100);
			}
			yield;
		}
	}
}


task TWheel(cnt,spd){
	let whl = CreateSprite(getrx(cnt), getry(cnt), dirimg~"CircleSpokes.png", [0,0,256,256], 41);
//	ObjRender_SetColor(whl,32,32,32);
//	ObjRender_SetBlendType(whl,BLEND_INV_DESTRGB);
	ObjRender_SetColor(whl,128,0,64);
	ObjRender_SetBlendType(whl,BLEND_ADD_RGB);
	ObjRender_SetScaleXYZ(whl,0,0,1);
	BindPos(whl,cnt);
	while(!Obj_IsDeleted(cnt)){
		ObjRender_SetScaleXYZ(whl,ObjRender_GetScaleX(cnt),ObjRender_GetScaleY(cnt),1);
		//ObjRender_SetPosition(whl,getrx(cnt),getry(cnt),0);
		//ObjRender_SetPosition(whl,cx,cy,0);
		ObjRender_SetAngleZ(whl,ObjRender_GetAngleZ(whl)+spd);
		//ObjRender_SetAngleZ(cnt,ObjRender_GetAngleZ(cnt)+mag);		
		yield;
	}
	Obj_Delete(whl);
}



// task TShotWall{
// //	while(phase<7){yield;}
	
	// let shot; let shots;
	// let x; let y; let dir=1;
	// let ang = 90;
	// let seobj=ObjSound_Create;
	
	// let circ = NULL; //let circpush = NULL;
	// let rad; let mrad = sy; //getdist(0,0,sx,sy);
	
	// let count = 0;

	// while(!isnull(boss)){
		// ascent(i in 0..mrad/2){
			// loop(2){
				// shot = CreateShotA2(cx+i*dir*cos(ang)+rand(-3,3),cy+i*dir*sin(ang)+rand(-3,3),0,ang+90-90*dir, 0.00001*i,2.5,  BALL_MAGENTA+500, 15);
				// ObjShot_SetSpellResist(shot,true);
				// ObjShot_SetAutoDelete(shot,false);
				// dir*=-1;
			// }
			// SE_PlayA2(se_chime2,100,seobj,30);
			// wait(floor(rand(0,rand(1,3))));
		// }
		// wait(30);
		
		// if(isnull(circ)){circ = InfluenceCircleA1(cx,cy,0,INFL_REVOLVE,1,1);}
		// ascent(i in 0..500){
			// rad = mrad*0.5*(|sin(count)|);
			// ObjRender_SetScaleXYZ(circ,rad/128,rad/128,1);
			
			// if(randint(0,15)==0){ShrinkRotCircle(rand(0,sx),rand(0,sy),3*randSign,rand(50,rand(50,100)),60);}
			// if(randint(0,15)==0){ShrinkRotCircle(px,py,rand(-3,3),rand(50,rand(50,100)),60);}
			
			// yield; count++;
		// }
		// //ObjMove_SetDestAtScale(boss,px,py,60,1);
		
		// //wait(240);
	// }
	
// }






function Wall(x0,y0,x1,y1, x2,y2,x3,y3, num, time){
	let shot; //let x; let y; 
	let pos0; let pos1;
	let ang0 = getangle(x0,y0,x1,y1);
	let ang1 = getangle(x2,y2,x3,y3);
	let dist0= getdist(x0,y0,x1,y1);
	let dist1= getdist(x2,y2,x3,y3);
	
	let dist; let ang;
	
	ascent(i in 0..num){
		pos0 = blerp(x0,y0,x1,y1, i/num);
		pos1 = blerp(x2,y2,x3,y3, i/num);
		dist = getdist(pos0[0],pos0[1],pos1[0],pos1[1]);
		ang  = getangle(pos0[0],pos0[1],pos1[0],pos1[1]);
		shot = CreateShotA1(pos0[0],pos0[1],dist/(time+rand(-10,10)),ang, BIGDOT_HOLLOW_RED+500,25);
		//ObjMove_SetDestAtFrame(shot,pos1[0],pos1[1],time);
	}
}



task TWalls{
	while(!Obj_IsDeleted(boss)){
		//Wall(0,0,sx,0,  0,sy,sx,sy,  50, rand(240,360));
		//wait(120);
		SE_Play(se_exshot,100);
		SE_Play(se_shot,40);
		Wall(ex,ey,cx+cx*randSign,py,  0,sy,sx,sy,  50, rand(240,360));
		if(py<ey){Wall(rx,ry,rx,ry,  0,0,sx,0,  100, rand(240,360));}
		wait(60);
		SE_Play(se_exshot,100);
		SE_Play(se_shot,40);
		Wall(cx+rx/2*0.9,ry,cx+cx*randSign,ey,  0+cx*randSign,sy,sx-cx*randSign,sy-ry/4,  50, rand(240,360));
		if(py<ey){Wall(rx,ry,rx,ry,  0,0,sx,0,  100, rand(240,360));}
		wait(60);
	}
}















task TCrush{
	
	let circ = TPlayerGap(sx,sy,0,0);
	setval(circ,"Update",true);
	ascent(i in 0..120){
		ObjRender_SetScaleXYZ(circ,sx*1.75/128*i/120,sx*1.75/128*i/120,1);
		setval(circ,"Mag",-(i/240) );
		yield;
	}
	
	
}






// function ShrinkWarpCircle(x,y,spd,size,dur){
// //	SE_Play(se_chime2,100);
	// let circ = TPlayerGap(x,y,size,spd); //InfluenceCircleA1(x,y,size,INFL_REVOLVE,spd,1);
	// task TUpdate{
		// ascent(i in 0..dur){
			// ObjRender_SetScaleXYZ(circ,size/128*i/dur,size/128*i/dur,1);
			// yield;
		// }
		// descent(i in 0..dur){
			// ObjRender_SetScaleXYZ(circ,size/128*i/dur,size/128*i/dur,1);
			// yield;
		// }
		// Obj_Delete(circ);
	// }
	// TUpdate;
	// return circ;
// }